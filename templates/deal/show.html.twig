{% extends 'base.html.twig' %}

{% block title %}
	{{ deal.name }}
	- Bon plan
{% endblock %}

{% block body %}
	<div
		class="container mt-4 px-11">
		<!-- SECTION 1 : LE DEAL -->
		<div class="card  position-relative">
			<div
				class="d-flex align-items-start gap-3 border shadow-sm rounded-3 p-4">

				<!-- Vote Box -->
				<div class="d-flex flex-column align-items-center me-3 align-self-center">
					<button class="btn btn-deal btn-sm">▲</button>
					<span class="fw-bold text-danger">{{ deal.hotScore }}°</span>
					<button class="btn btn-deal btn-sm">▼</button>
				</div>

				<!-- Image du deal -->
				<div class="me-3">
					<img src="{{ deal.image }}" alt="Deal Image" class="img-fluid rounded" style="width: 304px; height: 304px; object-fit: cover; border-radius: 12px;">
				</div>

				<!-- Contenu du deal -->
				<div
					class="flex-grow-1 align-self-center">

					<!-- Titre du deal -->
					<div class="d-flex justify-content-between align-items-center mb-1">
						<a href="{{ path('deal_show', {'id': deal.id}) }}" class="text-black text-decoration-none fw-bold fs-4">
							{{ deal.name }}
						</a>
					</div>
					<span class="badge badge bg-light text-grey">
						Posté
						{{ deal.createdAt|ago }}
					</span>

					<!-- Prix et informations du deal -->
					<p class="text-muted small mb-1 d-flex align-items-center flex-wrap gap-2">
						<strong class="text-danger fs-2">{{ deal.price }}€</strong>
						<s class="text-secondary fs-4">{{ deal.originalPrice }}€</s>
						<span class="badge bg-success fs-6">-{{ ((1 - (deal.price / deal.originalPrice)) * 100)|round }}%</span>

					</p>

					<!-- 🏪 Disponible chez le marchand -->
						<span>
						<!-- 🚚 Livraison -->
						<i class="bi bi-truck text-secondary "></i>
						<span>{{ deal.deliveryPrice is null or deal.deliveryPrice == 0 ? 'Gratuit' : deal.deliveryPrice ~ '€' }}</span>
						| Disponible chez
							<a href="{{ path('merchant_show', {'id': deal.merchant.id}) }}" class="fw-bold text-black text-decoration-none">
								{{ deal.merchant.name }}
							</a>
						</span>

					<!-- Infos complémentaires -->
					<div class="d-flex align-items-center mt-auto ">
						<p class="me-3">
							<a href="{{ path('deal_show', {'id': deal.id}) }}#comments" class="text-decoration-none text-black d-flex align-items-center">
								<i class="bi bi-chat me-1"></i>
								{{ deal.comments|length }}
							</a>
						</p>
						<p class="me-3">
							<i class="bi bi-share"></i>
						</p>
						<!-- Bouton Voir le deal -->
						<div class="ms-auto">
							<a href="{{ deal.dealUrl }}" target="_blank" class="btn btn-deal rounded-pill">Voir le deal
								<i class="bi bi-box-arrow-up-right mx-2"></i>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- SECTION 2 : DESCRIPTION -->
		<div class="card shadow-sm p-3 mt-4">
			<h5 class="fw-bold">À propos de ce deal</h5>
			<p class="text-muted">{{ deal.description }}</p>
		</div>

		<!-- SECTION 3 : DEALS SIMILAIRES -->

		<div class="card shadow-sm p-3 my-4">
			<h5 class="fw-bold m-3">Vous aimerez aussi</h5>
			<div class="d-flex overflow-auto gap-3">
				{% for relatedDeal in relatedDeals %}
					<div class="text-center" style="min-width: 140px;">
						<div class="position-relative">
							<span class="badge bg-danger position-absolute top-0 end-0 m-1">{{ relatedDeal.hotScore }}°</span>
							<a href="{{ path('deal_show', {'id': relatedDeal.id}) }}">
								<img src="{{ relatedDeal.image }}" alt="{{ relatedDeal.name }}" style="width: 140px; height: 140px; object-fit: cover;" class="rounded shadow-sm">
							</a>
						</div>

						<a href="{{ path('deal_show', {'id': relatedDeal.id}) }}" class="text-black text-decoration-none">
							<p class="mt-2 fw-semibold" style="max-width: 140px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ relatedDeal.name }}</p>
						</a>
						<p class="mb-0">
							<strong class="text-danger">{{ relatedDeal.price|number_format(2, ',', ' ') }}€</strong>
							{% if relatedDeal.originalPrice %}
								<small class="text-muted text-decoration-line-through">{{ relatedDeal.originalPrice|number_format(2, ',', ' ') }}€</small>
								<span class="badge bg-success fw-bold">{{ ((1 - relatedDeal.price / relatedDeal.originalPrice) * 100)|round(0) }}%</span>
							{% endif %}
						</p>
					</div>
				{% else %}
					<p class="text-muted">Aucun deal similaire trouvé.</p>
				{% endfor %}
			</div>
		</div>


		<!-- SECTION 3 : COMMENTAIRES -->
		<div id="comments" class="card shadow-sm p-3 my-4">
			<h5 class="fw-bold">Commentaires</h5>

			<!-- Section mettre un commentaire si l'utilisateur est connecté -->

			{% if app.user %}
				<div class="d-flex align-items-start border-bottom pb-3 my-3">
					<img src="{{app.user.image}}" alt="Avatar" class="rounded-circle" style="width: 54px; height: 54px; object-fit: cover;">

					<div class="ms-3 flex-grow-1">
						<form method="post" action="">
							<div class="mb-2">
								<textarea name="content" class="form-control" rows="3" placeholder="Écrire un commentaire..." required></textarea>
							</div>
							<div class="d-flex justify-content-end">
								<button type="submit" class="btn btn-deal rounded-pill">
									<i class="bi bi-send mx-1"></i>
									Publier
								</button>
							</div>

						</form>
					</div>
				</div>
			{% else %}
				<p class="text-muted">Veuillez
					<a href="#" data-bs-toggle="modal" data-bs-target="#loginModal">vous connecter</a>
					pour ajouter un commentaire.</p>
			{% endif %}

			<!-- Section liste des commentaires du deal -->


			{% for comment in deal.comments %}
				<div
					class="d-flex align-items-start mt-3">
					<!-- Avatar -->
					<img
					src="{{ comment.user.image }}" alt="Avatar" class="rounded-circle" style="width: 54px; height: 54px; object-fit: cover;">

					<!-- Contenu du commentaire -->
					<div class="ms-3 w-100">
						<strong>{{ comment.user.username }}</strong>
						<p class="mb-1">{{ comment.content }}</p>
						<small class="text-muted">{{ comment.createdAt|date('d/m/Y à H:i') }}</small>

						<!-- Section des actions (votes + réponse) -->
						<div
							class="d-flex align-items-center mt-2 gap-3">
							<!-- Boutons de vote -->
							<button class="btn btn-sm btn-outline-success vote-btn" data-id="{{ comment.id }}" data-type="upvote">
								<i class="bi bi-hand-thumbs-up"></i>
								<span class="positive-votes">{{ comment.positiveVotes }}</span>
							</button>

							<button class="btn btn-sm btn-outline-danger vote-btn" data-id="{{ comment.id }}" data-type="downvote">
								<i class="bi bi-hand-thumbs-down"></i>
								<span class="negative-votes">{{ comment.negativeVotes }}</span>
							</button>

							<!-- Bouton pour répondre -->
							<button class="btn btn-sm btn-outline-secondary reply-btn" data-id="{{ comment.id }}">
								<i class="bi bi-reply-fill"></i>
								Répondre
							</button>
						</div>

						<!-- Formulaire de réponse caché par défaut -->
						<div class="reply-form mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
							<textarea class="form-control mb-2" rows="2" placeholder="Votre réponse..."></textarea>
							<button class="btn btn-deal rounded-pill btn-sm">Envoyer la réponse</button>
						</div>
					</div>
				</div>
			{% else %}
				<p class="text-muted">Aucun commentaire pour le moment.</p>
			{% endfor %}

		</div>
	</div>

	<!-- Script pour ouvrir le champ de text de réponse -->
{% endblock %}
