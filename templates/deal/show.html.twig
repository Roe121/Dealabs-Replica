{% extends 'base.html.twig' %}


{% block title %}
	{{ deal.name }}
	- Bon plan
{% endblock %}

{% block body %}
	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<script>
				Swal.fire({
icon: '{{ label }}', // success, error, warning, info
title: '{{ message }}',
showConfirmButton: false,
timer: 2000 // Disparaît après 1.5 secondes
});
			</script>
		{% endfor %}
	{% endfor %}

	<meta name="csrf-token" content="{{ csrf_token('edit_comment') }}">


	<div
		id="deal-show" class="container mt-4 px-11 d-flex flex-column gap-3">
		<!-- SECTION 1 : LE DEAL -->
		<div class="card  position-relative rounded-card-border">
			<div
				class="d-flex align-items-start gap-3  shadow-sm  p-4">

				<!-- Vote Box -->
				<div class="d-flex flex-column align-items-center me-3 align-self-center">
					<button class="btn btn-deal btn-sm">▲</button>
					<span class="fw-bold text-danger">{{ deal.hotScore }}°</span>
					<button class="btn btn-deal btn-sm">▼</button>
				</div>

				<!-- Image du deal -->
				<div class="me-3">
					<img src="{{ deal.image }}" alt="Deal Image" class="img-fluid rounded" style="width: 304px; height: 304px; object-fit: cover; border-radius: 12px;">
				</div>

				<!-- Contenu du deal -->
				<div
					class="flex-grow-1 align-self-center">

					<!-- Titre du deal -->
					<div class="d-flex justify-content-between align-items-center mb-1">
						<a href="{{ path('deal_show', {'id': deal.id}) }}" class="text-black text-decoration-none fw-bold fs-4">
							{{ deal.name }}
						</a>
					</div>
					<span class="badge badge bg-light text-grey">
						Posté
						{{ deal.createdAt|ago }}
					</span>

					<!-- Prix et informations du deal -->
					<p class="text-muted small mb-1 d-flex align-items-center flex-wrap gap-2">
						<strong class="text-danger fs-2">{{ deal.price }}€</strong>
						<s class="text-secondary fs-4">{{ deal.originalPrice }}€</s>
						<span class="badge bg-success fs-6">-{{ ((1 - (deal.price / deal.originalPrice)) * 100)|round }}%</span>

					</p>

					<!-- 🏪 Disponible chez le marchand -->
					<span>
						<!-- 🚚 Livraison -->
						<i class="bi bi-truck text-secondary "></i>
						<span>{{ deal.deliveryPrice is null or deal.deliveryPrice == 0 ? 'Gratuit' : deal.deliveryPrice ~ '€' }}</span>
						| Disponible chez
						<a href="{{ path('merchant_show', {'id': deal.merchant.id}) }}" class="fw-bold text-black text-decoration-none">
							{{ deal.merchant.name }}
						</a>
					</span>

					<!-- Infos complémentaires -->
					<div class="d-flex align-items-center mt-auto ">
						<p class="me-3">
							<a href="{{ path('deal_show', {'id': deal.id}) }}#comments" class="text-decoration-none text-black d-flex align-items-center">
								<i class="bi bi-chat me-1"></i>
								{{ deal.comments|length }}
							</a>
						</p>
						<p class="me-3">
							<i class="bi bi-share"></i>
						</p>
						<!-- Bouton Voir le deal -->
						<div class="ms-auto">
							<a href="{{ deal.dealUrl }}" target="_blank" class="btn btn-deal rounded-pill">Voir le deal
								<i class="bi bi-box-arrow-up-right mx-2"></i>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- SECTION 2 : DESCRIPTION -->
		<div class="card shadow-sm p-3 rounded-card-border ">
			<h5 class="fw-bold mb-4 mt-2">À propos de ce deal</h5>

			<!-- User Info -->
			<div class="d-flex align-items-center mb-3">
				<img src="{{ deal.user.image }}" alt="Avatar" class="rounded-circle me-2" width="40" height="40">
				<div>
					<a href="{{ path('user_show', {'id': deal.user.id}) }}" class="fw-bold text-black text-decoration-none">{{ deal.user.username }}</a>
					<div class="text-muted small">
						<i class="bi bi-calendar"></i>
						Membre depuis
						{{ deal.user.createdAt|date('Y') }}


						<i class="bi bi-tag ms-2"></i>
						{{ deal.user.deals|length }}
					</div>
				</div>
			</div>

			<!-- Deal Description -->
			<p>{{ deal.description }}</p>
		</div>


		<!-- SECTION 3 : DEALS SIMILAIRES -->

		<div class="card shadow-sm p-3 rounded-card-border">
			<h5 class="fw-bold m-3">Vous aimerez aussi</h5>
			<div class="d-flex overflow-auto gap-3">
				{% for relatedDeal in relatedDeals %}
					<div class="text-center" style="min-width: 140px;">
						<div class="position-relative">
							<span class="badge bg-danger position-absolute top-0 end-0 m-1">{{ relatedDeal.hotScore }}°</span>
							<a href="{{ path('deal_show', {'id': relatedDeal.id}) }}">
								<img src="{{ relatedDeal.image }}" alt="{{ relatedDeal.name }}" style="width: 140px; height: 140px; object-fit: cover;" class="rounded shadow-sm">
							</a>
						</div>

						<a href="{{ path('deal_show', {'id': relatedDeal.id}) }}" class="text-black text-decoration-none">
							<p class="mt-2 fw-semibold" style="max-width: 140px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ relatedDeal.name }}</p>
						</a>
						<p class="mb-0">
							<strong class="text-danger">{{ relatedDeal.price|number_format(2, ',', ' ') }}€</strong>
							{% if relatedDeal.originalPrice %}
								<small class="text-muted text-decoration-line-through">{{ relatedDeal.originalPrice|number_format(2, ',', ' ') }}€</small>
								<span class="badge bg-success fw-bold">{{ ((1 - relatedDeal.price / relatedDeal.originalPrice) * 100)|round(0) }}%</span>
							{% endif %}
						</p>
					</div>
				{% else %}
					<p class="text-muted">Aucun deal similaire trouvé.</p>
				{% endfor %}
			</div>
		</div>


		<!-- SECTION 3 : COMMENTAIRES -->
		
		{% include 'partials/_comment_section.html.twig' %}

	</div>


{% endblock %}
