{% extends 'base.html.twig' %}

{% block title %}
	{{ deal.name }}
	- Bon plan
{% endblock %}

{% block body %}
	<div
		class="container mt-4 px-8">
		<!-- SECTION 1 : LE DEAL -->
		<div class="card shadow-sm p-3">
			<div
				class="d-flex align-items-start">
				<!-- Image du deal -->
				<div class="p-3 bg-white rounded" style="display: inline-block;">
					<img src="{{ deal.image }}" alt="{{ deal.name }}" class="rounded" style="width: 304px; height: 304px; object-fit: cover;">
				</div>
				<div
					class="ms-3">
					<!-- Infos deal -->
					<h3 class="fw-bold">{{ deal.name }}</h3>
					<div class="d-flex align-items-center">
						<span class="text-danger fs-4 fw-bold me-2">{{ deal.price|number_format(2, ',', ' ') }}€</span>
						{% if deal.originalPrice %}
							<span class="text-muted text-decoration-line-through me-2">{{ deal.originalPrice|number_format(2, ',', ' ') }}€</span>
							<span class="badge bg-success">-{{ ((1 - (deal.price / deal.originalPrice)) * 100)|round }}%</span>
						{% endif %}
					</div>

					<div class="mt-3">
						<a href="{{ deal.dealUrl }}" target="_blank" class="btn btn-deal rounded-pill w-50">
							Voir le deal
							<i class="bi bi-box-arrow-up-right"></i>
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- SECTION 2 : DESCRIPTION -->
		<div class="card shadow-sm p-3 mt-4">
			<h5 class="fw-bold">À propos de ce deal</h5>
			<p class="text-muted">{{ deal.description }}</p>
		</div>

		<!-- SECTION 3 : COMMENTAIRES -->
		<div class="card shadow-sm p-3 my-4">
			<h5 class="fw-bold">Commentaires</h5>

			<!-- Section mettre un commentaire si l'utilisateur est connecté -->

			{% if app.user %}
				<div class="d-flex align-items-start border-bottom pb-3 my-3">
					<img src="https://randomuser.me/api/portraits/men/7.jpg" alt="Avatar" class="rounded-circle" style="width: 54px; height: 54px; object-fit: cover;">

					<div class="ms-3 flex-grow-1">
						<form method="post" action="">
							<div class="mb-2">
								<textarea name="content" class="form-control" rows="3" placeholder="Écrire un commentaire..." required></textarea>
							</div>
							<div class="d-flex justify-content-end">
								<button type="submit" class="btn btn-deal rounded-pill">
									<i class="bi bi-send mx-1"></i>
									Publier
								</button>
							</div>

						</form>
					</div>
				</div>
			{% else %}
				<p class="text-muted">Veuillez
					<a href="#" data-bs-toggle="modal" data-bs-target="#loginModal">vous connecter</a>
					pour ajouter un commentaire.</p>
			{% endif %}

			<!-- Section liste des commentaires du deal -->


			{% for comment in deal.comments %}
				<div
					class="d-flex align-items-start mt-3">
					<!-- Avatar -->
					<img
					src="https://randomuser.me/api/portraits/men/{{ comment.id }}.jpg" alt="Avatar" class="rounded-circle" style="width: 54px; height: 54px; object-fit: cover;">

					<!-- Contenu du commentaire -->
					<div class="ms-3 w-100">
						<strong>{{ comment.user.username }}</strong>
						<p class="mb-1">{{ comment.content }}</p>
						<small class="text-muted">{{ comment.createdAt|date('d/m/Y à H:i') }}</small>

						<!-- Section des actions (votes + réponse) -->
						<div
							class="d-flex align-items-center mt-2 gap-3">
							<!-- Boutons de vote -->
							<button class="btn btn-sm btn-outline-success vote-btn" data-id="{{ comment.id }}" data-type="upvote">
								<i class="bi bi-hand-thumbs-up"></i>
								<span class="positive-votes">{{ comment.positiveVotes }}</span>
							</button>

							<button class="btn btn-sm btn-outline-danger vote-btn" data-id="{{ comment.id }}" data-type="downvote">
								<i class="bi bi-hand-thumbs-down"></i>
								<span class="negative-votes">{{ comment.negativeVotes }}</span>
							</button>

							<!-- Bouton pour répondre -->
							<button class="btn btn-sm btn-outline-secondary reply-btn" data-id="{{ comment.id }}">
								<i class="bi bi-reply-fill"></i>
								Répondre
							</button>
						</div>

						<!-- Formulaire de réponse caché par défaut -->
						<div class="reply-form mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
							<textarea class="form-control mb-2" rows="2" placeholder="Votre réponse..."></textarea>
							<button class="btn btn-deal rounded-pill btn-sm">Envoyer la réponse</button>
						</div>
					</div>
				</div>
			{% else %}
				<p class="text-muted">Aucun commentaire pour le moment.</p>
			{% endfor %}

		</div>
	</div>

	<!-- Script pour ouvrir le champ de text de réponse -->
	<script>
	document.addEventListener('DOMContentLoaded', function() {
    // Gestion des votes
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.id;
            const voteType = this.dataset.type; // "upvote" ou "downvote"

            // Simuler l'incrémentation des votes
            const counter = this.querySelector(voteType === 'upvote' ? '.positive-votes' : '.negative-votes');
            counter.textContent = parseInt(counter.textContent) + 1;

            // TODO: Envoyer la requête AJAX à Symfony ici
            console.log(`Vote ${voteType} pour le commentaire ID: ${commentId}`);
        });
    });

    // Affichage du formulaire de réponse
    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.id;
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        });
    });
});

</script>
{% endblock %}


