{% extends 'base.html.twig' %}

{% block title %}Liste des Deals
{% endblock %}

{% block body %}

	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<script>
				Swal.fire({
icon: '{{ label }}', // success, error, warning, info
title: '{{ message }}',
showConfirmButton: false,
timer: 3000 // Dispara√Æt apr√®s 3 secondes
});
			</script>
		{% endfor %}
	{% endfor %}


	<div class="container my-5 px-4">
		<h1 class="mb-4">Tous les deals</h1>

		{% if deals is not empty %}
			<div
				class="row g-2">

				<!-- Colonne principale (75%) -->
				<div class="col-md-9">
					{% for deal in deals %}
						<div
							class="card shadow-sm border-0 p-3 d-flex flex-row align-items-center mb-2">
							<!-- Vote Box -->
							<div class="d-flex flex-column align-items-center me-3">
								<button class="btn btn-deal btn-sm">‚ñ≤</button>
								<span class="fw-bold text-danger">{{ deal.hotScore }}¬∞</span>
								<button class="btn btn-deal btn-sm">‚ñº</button>
							</div>

							<!-- Image du deal -->
							<div class="me-3">
								<img src="{{ deal.image }}" alt="Deal Image" class="img-fluid rounded" style="width: 202px; height: 202px; object-fit: cover; border-radius: 12px;">
							</div>

							<!-- Contenu du deal -->
							<div class="flex-grow-1">
								<div class="d-flex justify-content-between align-items-center mb-1">
									<a href="{{ path('deal_show', {'id': deal.id}) }}" class="text-black text-decoration-none fw-bold fs-5">
										{{ deal.name }}
									</a>
									<span class="badge badge bg-light text-grey ms-2">
										Post√©
										{{ deal.createdAt|ago }}

									</span>
								</div>
								<p class="text-muted small mb-1 d-flex align-items-center flex-wrap gap-2">
									<strong class="text-danger fs-4">{{ deal.price }}‚Ç¨</strong>
									<s class="text-secondary">{{ deal.originalPrice }}‚Ç¨</s>
									<span class="badge bg-success fs-6">-{{ ((1 - (deal.price / deal.originalPrice)) * 100)|round }}%</span>

									<!-- üöö Livraison -->
									<i class="bi bi-truck text-secondary "></i>
									<span>{{ deal.deliveryPrice is null or deal.deliveryPrice == 0 ? 'Gratuit' : deal.deliveryPrice ~ '‚Ç¨' }}</span>

									<!-- üè™ Disponible chez le marchand -->
									<span>| Disponible chez
										<a href="{{ path('merchant_show', {'id': deal.merchant.id}) }}" class="fw-bold text-black text-decoration-none">
											{{ deal.merchant.name }}
										</a>
									</span>

									<!-- üë§ Partag√© par l'utilisateur -->
									<span class="d-flex align-items-center ms-2">
										<img src="{{ deal.user.image }}" alt="User Image" class="rounded-circle me-1" style="width: 18px; height: 18px; object-fit: cover;">
										Partag√© par&nbsp;
										<a href="{{ path('deal_show', {'id': deal.id}) }}" class="fw-bold text-black text-decoration-none">
											{{ deal.user.username }}</a>

									</span>
								</p>
							</a>

							<p class="text-muted small mb-2">{{ deal.description|length > 100 ? deal.description[:100] ~ '...' : deal.description }}</p>

							<!-- Infos compl√©mentaires -->
							<div class="d-flex align-items-center mt-auto">
								<p class="me-3">
									<a href="{{ path('deal_show', {'id': deal.id}) }}#comments" class="text-decoration-none text-black d-flex align-items-center">
										<i class="bi bi-chat me-1"></i>
										{{ deal.comments|length }}
									</a>
								</p>
								<p class="me-3">
									<i class="bi bi-share"></i>

								</p>
								<!-- Bouton Voir le deal -->
								<div class="ms-auto">
									<a href="{{ deal.dealUrl }}" target="_blank" class="btn btn-deal rounded-pill">Voir le deal
										<i class="bi bi-box-arrow-up-right mx-2"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>

			<!-- Sidebar "Deals les + hot" -->
			<div class="col-md-3 d-flex flex-column gap-2">
				<div class="card p-3 shadow-sm">
					<h5 class="mb-3">Deals les + hot</h5>
					{% set hotDeals = deals|sort((a, b) => b.hotScore <=> a.hotScore)[:3] %}
					{% for deal in hotDeals %}
						<div class="d-flex align-items-center mb-3">
							<img src="{{ deal.image }}" alt="Hot Deal Image" class="rounded" style="width: 84px; height: 84px; object-fit: cover; border-radius: 8px;">
							<div class="ms-3 w-100">

								<h6 class="mb-0">
									<a href="{{ path('deal_show', {'id': deal.id}) }}" class="text-black text-decoration-none">
										<span class="fw-bold text-danger">{{ deal.hotScore }}¬∞</span>
										{{ deal.name }}
									</a>
								</h6>
								<h6 class="text-danger text-end bolder ">{{ deal.price }}‚Ç¨</h6>
							</div>
						</div>
					{% endfor %}
				</div>


				<!-- Sidebar "Activit√©" (Seulement si utilisateur connect√©) -->
				{% if app.user %}
					<div class="card p-3 shadow-sm ">
						<h5 class="mb-3">Activit√©</h5>
						{% for comment in app.user.comments|slice(0,5) %}
							<div class="d-flex align-items-center mb-2">
								<img src="{{ comment.deal.image }}" alt="Activity Deal" class="rounded" style="width: 54px; height: 54px; object-fit: cover;">
								<div class="ms-2">
									<small class="text-muted">Vous avez comment√© le deal</small>
									<a href="{{ path('deal_show', {'id': comment.deal.id}) }}" class="d-block text-black text-decoration-none small">{{ comment.deal.name }}</a>
									<small class="text-muted">
										<i class="bi bi-chat"></i>
										{{ comment.createdAt|date('d F Y') }}</small>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}

				<!-- Sidebar "Discussions" (Tous le monde peut voir) -->
				<div class="card p-3 shadow-sm">
					<h5 class="mb-3">Discussions
						<span class="text-primary">‚ñæ</span>
					</h5>

					<!-- Discussion 1 -->
					<div class="d-flex align-items-center mb-2">
						<img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User Avatar" class="rounded-circle" style="width: 26px; height: 26px; object-fit: cover;">
						<div class="ms-2">
							<a href="#" class="d-block text-black text-decoration-none small fw-bold">ClemS</a>
							<a href="#" class="d-block text-black text-decoration-none small">Trade Republic lance un compte courant...</a>
							<small class="text-muted">
								<i class="bi bi-chat"></i>
								354
							</small>
						</div>
					</div>

					<!-- Discussion 2 -->
					<div class="d-flex align-items-center mb-2">
						<img src="https://randomuser.me/api/portraits/women/45.jpg" alt="User Avatar" class="rounded-circle" style="width: 26px; height: 26px; object-fit: cover;">
						<div class="ms-2">
							<a href="#" class="d-block text-black text-decoration-none small fw-bold">nrslr</a>
							<a href="#" class="d-block text-black text-decoration-none small">LeBonCoin : √Ä quand la livraison √† 0,99‚Ç¨ ?</a>
							<small class="text-muted">
								<i class="bi bi-chat"></i>
								53
							</small>
						</div>
					</div>

					<!-- Discussion 3 -->
					<div class="d-flex align-items-center mb-2">
						<img src="https://randomuser.me/api/portraits/men/12.jpg" alt="User Avatar" class="rounded-circle" style="width: 26px; height: 26px; object-fit: cover;">
						<div class="ms-2">
							<a href="#" class="d-block text-black text-decoration-none small fw-bold">El_Maak</a>
							<a href="#" class="d-block text-black text-decoration-none small">[Happy you !] Ces sites, magasins et restaurants qui offrent un cadeau...</a>
							<small class="text-muted">
								<i class="bi bi-chat"></i>
								206
							</small>
						</div>
					</div>
				</div>

			</div>

		</div>
	{% else %}
		<div class="alert alert-info text-center" role="alert">
			Aucun deal trouv√©.
		</div>
	{% endif %}
</div>{% endblock %}
